// スプレッドシートIDを設定してください（URLから取得）
// https://docs.google.com/spreadsheets/d/【この部分がスプレッドシートID】/edit
const SPREADSHEET_ID = "1cD1EuQImBECV20tioWw4coTSYFQSTg0j_zHfQ-QBFeU"; // ← NFCログDBのスプレッドシートID

function doGet(e) {
  try {
    console.log('GET リクエストを受信:', e.parameter);
    
    // パラメータから各種データを取得
    const timestamp = e.parameter.timestamp || new Date().toLocaleString('ja-JP');
    const device = e.parameter.device || 'Unknown';
    const action = e.parameter.action || 'checkin';
    const userName = e.parameter.userName || 'Unknown';
    const userFile = e.parameter.userFile || '';
    
    console.log('チェックイン情報:', {
      timestamp: timestamp,
      userName: userName,
      action: action,
      device: device,
      userFile: userFile
    });
    
    // スプレッドシートを開く
    let spreadsheet;
    let sheet;
    
    if (SPREADSHEET_ID && SPREADSHEET_ID !== "") {
      // IDを指定してスプレッドシートを開く
      console.log('スプレッドシートIDで開く:', SPREADSHEET_ID);
      spreadsheet = SpreadsheetApp.openById(SPREADSHEET_ID);
      sheet = spreadsheet.getActiveSheet();
    } else {
      // IDが設定されていない場合は、現在のスプレッドシートを使用
      console.log('現在のスプレッドシートを使用');
      spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
      sheet = spreadsheet.getActiveSheet();
    }
    
    console.log('スプレッドシート名:', spreadsheet.getName());
    console.log('シート名:', sheet.getName());
    
    // 現在の最終行を取得
    const lastRow = sheet.getLastRow();
    const nextRow = lastRow + 1;
    
    console.log('現在の最終行:', lastRow, '次の行:', nextRow);
    
    // 各列にデータを記録
    // A列: 時刻
    sheet.getRange(nextRow, 1).setValue(timestamp);
    
    // B列: ユーザー
    sheet.getRange(nextRow, 2).setValue(userName);
    
    // C列: アクション
    sheet.getRange(nextRow, 3).setValue(action);
    
    // D列: 備考（デバイス情報など）
    let remarks = device;
    if (userFile && userFile !== 'unknown' && userFile !== '') {
      remarks += ` (ファイル: ${userFile})`;
    }
    sheet.getRange(nextRow, 4).setValue(remarks);
    
    // E列: パラメータ（デバッグ用）
    const parameterInfo = JSON.stringify({
      device: device,
      action: action,
      timestamp: timestamp,
      ...(userFile && userFile !== 'unknown' && userFile !== '' && { userFile: userFile }),
      ...(userName && userName !== 'Unknown' && { userName: userName })
    });
    sheet.getRange(nextRow, 5).setValue(parameterInfo);
    
    // 書き込み後の確認
    const writtenData = {
      timestamp: sheet.getRange(nextRow, 1).getValue(),
      userName: sheet.getRange(nextRow, 2).getValue(),
      action: sheet.getRange(nextRow, 3).getValue(),
      remarks: sheet.getRange(nextRow, 4).getValue(),
      parameters: sheet.getRange(nextRow, 5).getValue()
    };
    
    console.log('チェックイン記録完了:', writtenData);
    
    // 成功レスポンス
    const responseData = {
      status: 'success',
      message: `${userName}さんのチェックインを記録しました`,
      action: action,
      timestamp: timestamp,
      userName: userName,
      device: device,
      row: nextRow,
      lastRow: lastRow,
      sheetName: sheet.getName(),
      spreadsheetName: spreadsheet.getName(),
      writtenData: writtenData,
      method: 'GET'
    };
    
    console.log('レスポンス:', responseData);
    
    return ContentService
      .createTextOutput(JSON.stringify(responseData))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    console.error('GET エラー:', error);
    console.error('エラー詳細:', error.toString());
    console.error('スタック:', error.stack);
    
    return ContentService
      .createTextOutput(JSON.stringify({
        status: 'error',
        message: 'チェックインエラー: ' + error.toString(),
        action: 'checkin',
        error: error.name,
        stack: error.stack,
        method: 'GET'
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function doPost(e) {
  try {
    console.log('POST リクエストを受信:', e.parameter, e.postData);
    
    // 受信したデータを取得
    let timestamp;
    let device = 'Unknown';
    let action = 'checkin';
    let userName = 'Unknown';
    let userFile = '';
    
    if (e.postData && e.postData.contents) {
      try {
        const data = JSON.parse(e.postData.contents);
        timestamp = data.timestamp || new Date().toLocaleString('ja-JP');
        device = data.device || 'Unknown';
        action = data.action || 'checkin';
        userName = data.userName || 'Unknown';
        userFile = data.userFile || '';
      } catch (jsonError) {
        console.log('JSON解析エラー:', jsonError);
        timestamp = e.postData.contents;
      }
    } else if (e.parameter.timestamp) {
      timestamp = e.parameter.timestamp;
      device = e.parameter.device || 'Unknown';
      action = e.parameter.action || 'checkin';
      userName = e.parameter.userName || 'Unknown';
      userFile = e.parameter.userFile || '';
    } else {
      timestamp = new Date().toLocaleString('ja-JP');
    }
    
    console.log('チェックイン情報:', {
      timestamp: timestamp,
      userName: userName,
      action: action,
      device: device,
      userFile: userFile
    });
    
    // スプレッドシートを開く
    let spreadsheet;
    let sheet;
    
    if (SPREADSHEET_ID && SPREADSHEET_ID !== "") {
      console.log('スプレッドシートIDで開く:', SPREADSHEET_ID);
      spreadsheet = SpreadsheetApp.openById(SPREADSHEET_ID);
      sheet = spreadsheet.getActiveSheet();
    } else {
      console.log('現在のスプレッドシートを使用');
      spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
      sheet = spreadsheet.getActiveSheet();
    }
    
    console.log('スプレッドシート名:', spreadsheet.getName());
    console.log('シート名:', sheet.getName());
    
    // 現在の最終行を取得
    const lastRow = sheet.getLastRow();
    const nextRow = lastRow + 1;
    
    console.log('現在の最終行:', lastRow, '次の行:', nextRow);
    
    // 各列にデータを記録
    // A列: 時刻
    sheet.getRange(nextRow, 1).setValue(timestamp);
    
    // B列: ユーザー
    sheet.getRange(nextRow, 2).setValue(userName);
    
    // C列: アクション
    sheet.getRange(nextRow, 3).setValue(action);
    
    // D列: 備考（デバイス情報など）
    let remarks = device;
    if (userFile && userFile !== 'unknown' && userFile !== '') {
      remarks += ` (ファイル: ${userFile})`;
    }
    sheet.getRange(nextRow, 4).setValue(remarks);
    
    // E列: パラメータ（デバッグ用）
    const parameterInfo = JSON.stringify({
      device: device,
      action: action,
      timestamp: timestamp,
      ...(userFile && userFile !== 'unknown' && userFile !== '' && { userFile: userFile }),
      ...(userName && userName !== 'Unknown' && { userName: userName })
    });
    sheet.getRange(nextRow, 5).setValue(parameterInfo);
    
    // 書き込み後の確認
    const writtenData = {
      timestamp: sheet.getRange(nextRow, 1).getValue(),
      userName: sheet.getRange(nextRow, 2).getValue(),
      action: sheet.getRange(nextRow, 3).getValue(),
      remarks: sheet.getRange(nextRow, 4).getValue(),
      parameters: sheet.getRange(nextRow, 5).getValue()
    };
    
    console.log('チェックイン記録完了:', writtenData);
    
    // 成功レスポンス
    const responseData = {
      status: 'success',
      message: `${userName}さんのチェックインを記録しました`,
      action: action,
      timestamp: timestamp,
      userName: userName,
      device: device,
      row: nextRow,
      lastRow: lastRow,
      sheetName: sheet.getName(),
      spreadsheetName: spreadsheet.getName(),
      writtenData: writtenData,
      method: 'POST'
    };
    
    console.log('レスポンス:', responseData);
    
    return ContentService
      .createTextOutput(JSON.stringify(responseData))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    console.error('POST エラー:', error);
    console.error('エラー詳細:', error.toString());
    console.error('スタック:', error.stack);
    
    return ContentService
      .createTextOutput(JSON.stringify({
        status: 'error',
        message: 'チェックインエラー: ' + error.toString(),
        action: 'checkin',
        error: error.name,
        stack: error.stack,
        method: 'POST'
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

// テスト用関数（Apps Scriptエディタで実行可能）
function testCheckinFunction() {
  try {
    console.log('チェックインテスト開始');
    
    const testTimestamp = new Date().toLocaleString('ja-JP');
    const testUserName = 'テストユーザー';
    const testAction = 'checkin';
    const testDevice = 'TestDevice';
    const testUserFile = 'test.txt';
    
    console.log('テスト情報:', {
      timestamp: testTimestamp,
      userName: testUserName,
      action: testAction,
      device: testDevice,
      userFile: testUserFile
    });
    
    // スプレッドシートを開く
    let spreadsheet;
    let sheet;
    
    if (SPREADSHEET_ID && SPREADSHEET_ID !== "") {
      spreadsheet = SpreadsheetApp.openById(SPREADSHEET_ID);
      sheet = spreadsheet.getActiveSheet();
    } else {
      spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
      sheet = spreadsheet.getActiveSheet();
    }
    
    console.log('スプレッドシート名:', spreadsheet.getName());
    console.log('シート名:', sheet.getName());
    
    const lastRow = sheet.getLastRow();
    const nextRow = lastRow + 1;
    
    console.log('最終行:', lastRow, '次の行:', nextRow);
    
    // 各列にテストデータを書き込み
    sheet.getRange(nextRow, 1).setValue(testTimestamp);  // A列: 時刻
    sheet.getRange(nextRow, 2).setValue(testUserName);   // B列: ユーザー
    sheet.getRange(nextRow, 3).setValue(testAction);     // C列: アクション
    sheet.getRange(nextRow, 4).setValue(`${testDevice} (ファイル: ${testUserFile})`); // D列: 備考
    sheet.getRange(nextRow, 5).setValue(JSON.stringify({ // E列: パラメータ
      device: testDevice,
      action: testAction,
      timestamp: testTimestamp,
      userFile: testUserFile,
      userName: testUserName
    }));
    
    console.log('チェックインテスト完了');
    
  } catch (error) {
    console.error('チェックインテストエラー:', error);
  }
}
