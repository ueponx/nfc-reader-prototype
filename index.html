/**
 * NFC スプレッドシートアクセスログ記録用 Google Apps Script
 * WebアプリURL: https://script.google.com/macros/s/AKfycbzMBcRkypaNHKm_3Z_22eQfsCa5jBLnhq5Py9jy215PV7hpjrTwkHCvqeYGU-Perso/exec
 * ログ記録先: https://docs.google.com/spreadsheets/d/1cD1EuQImBECV20tioWw4coTSYFQSTg0j_zHfQ-QBFeU/edit
 * 
 * 【重要】設定手順:
 * 1. ログ記録用のGoogleスプレッドシートを作成
 * 2. スプレッドシートのURLからID部分をコピー
 *    例: https://docs.google.com/spreadsheets/d/XXXXXXXXXXXXXXX/edit
 *    この XXXXXXXXXXXXXXX の部分がスプレッドシートID
 * 3. 下記の SPREADSHEET_ID を実際のIDに変更
 * 4. 保存して実行テストを行う
 * 5. WebアプリとしてデプロイするとHTMLアプリから使用可能
 */

// ログを記録するスプレッドシートのID（スプレッドシートのURLから取得）
// https://docs.google.com/spreadsheets/d/SPREADSHEET_ID/edit の SPREADSHEET_ID の部分
// 設定済み: https://docs.google.com/spreadsheets/d/1cD1EuQImBECV20tioWw4coTSYFQSTg0j_zHfQ-QBFeU/edit
const SPREADSHEET_ID = '1cD1EuQImBECV20tioWw4coTSYFQSTg0j_zHfQ-QBFeU';

// ログを記録するシート名
const LOG_SHEET_NAME = 'アクセスログ';

/**
 * Webアプリのメインエントリーポイント
 * POSTリクエストを処理してログを記録
 */
function doPost(e) {
  try {
    // リクエストボディを解析
    let requestData;
    try {
      requestData = JSON.parse(e.postData.contents);
    } catch (parseError) {
      return ContentService
        .createTextOutput(JSON.stringify({
          success: false,
          error: 'Invalid JSON format'
        }))
        .setMimeType(ContentService.MimeType.JSON);
    }

    console.log('受信データ:', requestData);

    // アクション別の処理
    if (requestData.action === 'log_access') {
      const result = logSpreadsheetAccess(requestData);
      return ContentService
        .createTextOutput(JSON.stringify(result))
        .setMimeType(ContentService.MimeType.JSON);
    } else {
      return ContentService
        .createTextOutput(JSON.stringify({
          success: false,
          error: 'Unknown action: ' + requestData.action
        }))
        .setMimeType(ContentService.MimeType.JSON);
    }

  } catch (error) {
    console.error('doPost エラー:', error);
    return ContentService
      .createTextOutput(JSON.stringify({
        success: false,
        error: error.toString()
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * スプレッドシートアクセスログを記録
 */
function logSpreadsheetAccess(data) {
  try {
    // スプレッドシートを開く
    const spreadsheet = SpreadsheetApp.openById(SPREADSHEET_ID);
    
    // ログシートを取得（存在しない場合は作成）
    let logSheet;
    try {
      logSheet = spreadsheet.getSheetByName(LOG_SHEET_NAME);
    } catch (error) {
      // シートが存在しない場合は作成
      logSheet = spreadsheet.insertSheet(LOG_SHEET_NAME);
      
      // ヘッダー行を追加
      logSheet.getRange(1, 1, 1, 5).setValues([
        ['アクセス時刻', 'スプレッドシートURL', 'ユーザーエージェント', '記録時刻', 'ログID']
      ]);
      
      // ヘッダー行をフォーマット
      const headerRange = logSheet.getRange(1, 1, 1, 5);
      headerRange.setFontWeight('bold');
      headerRange.setBackground('#e1f5fe');
      
      // 列幅を調整
      logSheet.setColumnWidth(1, 150); // アクセス時刻
      logSheet.setColumnWidth(2, 400); // スプレッドシートURL
      logSheet.setColumnWidth(3, 300); // ユーザーエージェント
      logSheet.setColumnWidth(4, 150); // 記録時刻
      logSheet.setColumnWidth(5, 100); // ログID
    }

    // 新しい行を追加
    const lastRow = logSheet.getLastRow();
    const newRow = lastRow + 1;
    
    // ログIDを生成（簡易版）
    const logId = 'LOG-' + Date.now().toString(36).toUpperCase();
    
    // 現在時刻（記録時刻）
    const recordTime = new Date().toLocaleString('ja-JP', {
      timeZone: 'Asia/Tokyo',
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit'
    });

    // データを挿入
    const rowData = [
      data.access_time || '不明',
      data.spreadsheet_url || '不明',
      data.user_agent || '不明',
      recordTime,
      logId
    ];

    logSheet.getRange(newRow, 1, 1, rowData.length).setValues([rowData]);

    // 成功レスポンス
    console.log('ログ記録完了:', {
      row: newRow,
      logId: logId,
      accessTime: data.access_time
    });

    return {
      success: true,
      message: 'アクセスログを記録しました',
      logId: logId,
      row: newRow
    };

  } catch (error) {
    console.error('ログ記録エラー:', error);
    return {
      success: false,
      error: 'ログ記録に失敗しました: ' + error.toString()
    };
  }
}

/**
 * テスト用の関数
 * スクリプトエディタで実行してテストできます
 */
function testLogFunction() {
  const testData = {
    action: 'log_access',
    spreadsheet_url: 'https://docs.google.com/spreadsheets/d/test123/edit',
    access_time: '2025/07/10 14:30:45',
    user_agent: 'Mozilla/5.0 (Test Browser)'
  };

  const result = logSpreadsheetAccess(testData);
  console.log('テスト結果:', result);
  return result;
}

/**
 * スプレッドシートIDが正しく設定されているかチェック
 */
function checkSpreadsheetId() {
  if (SPREADSHEET_ID === 'YOUR_SPREADSHEET_ID_HERE') {
    console.error('エラー: SPREADSHEET_ID を実際のスプレッドシートIDに変更してください');
    return false;
  }
  
  try {
    const spreadsheet = SpreadsheetApp.openById(SPREADSHEET_ID);
    console.log('スプレッドシート確認OK:', spreadsheet.getName());
    return true;
  } catch (error) {
    console.error('スプレッドシートアクセスエラー:', error);
    return false;
  }
}
