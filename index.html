<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>スマコネ</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status.waiting {
            background-color: #e3f2fd;
            color: #1976d2;
            border: 2px solid #bbdefb;
        }
        .status.success {
            background-color: #e8f5e8;
            color: #2e7d32;
            border: 2px solid #a5d6a7;
        }
        .status.error {
            background-color: #ffebee;
            color: #c62828;
            border: 2px solid #ef9a9a;
        }
        button {
            width: 100%;
            padding: 15px;
            background-color: #1976d2;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px 0;
        }
        button:hover {
            background-color: #1565c0;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            margin: 10px 0;
            box-sizing: border-box;
        }
        input:focus {
            outline: none;
            border-color: #4a90e2;
        }
        .section {
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
            margin-bottom: 15px;
        }
        .section:last-child {
            border-bottom: none;
        }
        h3 {
            color: #333;
            margin-bottom: 10px;
        }
        .debug-info {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 12px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .test-button {
            background-color: #ff5722;
        }
        .test-button:hover {
            background-color: #e64a19;
        }
        .nfc-button {
            background-color: #4CAF50;
        }
        .nfc-button:hover {
            background-color: #45a049;
        }
        .timestamp {
            text-align: center;
            color: #666;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>😊 スマコネ</h1>
        <div style="text-align: center; color: #666; margin-bottom: 20px;">
            スマイルコネクト（デバッグ版ベース）
        </div>
        
        <div class="section">
            <h3>👤 ユーザー設定</h3>
            <input type="text" id="testUserName" value="田中太郎" placeholder="テスト用ユーザー名" />
        </div>
        
        <div class="section">
            <h3>📱 チェックイン</h3>
            <div id="status" class="status waiting">準備完了</div>
            <div class="timestamp" id="currentTime"></div>
            
            <button class="test-button" onclick="testImageMethod()">🧪 手動テスト送信（Image方式）</button>
            <button class="nfc-button" id="nfcButton" onclick="startNFC()">📱 NFC読み込み開始</button>
        </div>
        
        <div class="section">
            <h3>🔍 デバッグ情報</h3>
            <div class="debug-info" id="debugInfo">ここにデバッグ情報が表示されます</div>
        </div>
    </div>

    <script>
        let isNFCActive = false;
        let lastSendTime = 0;
        const SEND_INTERVAL = 5000; // 5秒間は重複送信を防ぐ

        // 現在時刻の表示を更新
        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleString('ja-JP', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('currentTime').textContent = `現在時刻: ${timeString}`;
        }

        // 1秒ごとに時刻を更新
        setInterval(updateCurrentTime, 1000);
        updateCurrentTime();

        function updateStatus(message, type = 'waiting') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }

        function addDebugInfo(info) {
            const debugElement = document.getElementById('debugInfo');
            const timestamp = new Date().toLocaleString('ja-JP');
            debugElement.textContent += `[${timestamp}] ${info}\n`;
            console.log(`[${timestamp}] ${info}`);
        }

        // デバッグ版と同じURL構築方法
        function buildTestURL() {
            const gasUrl = 'https://script.google.com/macros/s/AKfycbywswLc2pqHUM4Ywc3ZD7JXzDvlgzwgJOzJE-rM3zZSrOeslstFYpW9LTUc91vn0bVy/exec';
            const userName = document.getElementById('testUserName').value.trim() || 'Unknown';
            
            const timestamp = new Date().toLocaleString('ja-JP');
            const params = new URLSearchParams({
                timestamp: timestamp,
                action: 'checkin',
                userName: userName,
                inputMethod: 'manual',
                device: 'Android NFC'
            });
            
            const fullUrl = `${gasUrl}?${params.toString()}`;
            addDebugInfo(`URL構築: ${fullUrl}`);
            addDebugInfo(`ユーザー名: ${userName}`);
            return fullUrl;
        }

        // 重複送信防止チェック
        function canSend() {
            const now = Date.now();
            if (now - lastSendTime < SEND_INTERVAL) {
                addDebugInfo(`重複送信防止: ${Math.round((SEND_INTERVAL - (now - lastSendTime)) / 1000)}秒待機が必要`);
                return false;
            }
            return true;
        }

        // デバッグ版と同じImage方式送信
        async function testImageMethod() {
            addDebugInfo('=== Image方式テスト開始 ===');
            
            if (!canSend()) {
                updateStatus('❌ 送信間隔が短すぎます。しばらく待ってください。', 'error');
                return;
            }
            
            const url = buildTestURL();
            updateStatus('🖼️ Image方式で送信中...', 'waiting');
            
            try {
                const img = new Image();
                
                const imagePromise = new Promise((resolve) => {
                    img.onload = function() {
                        addDebugInfo('Image: onload イベント発生（珍しい）');
                        resolve('success');
                    };
                    
                    img.onerror = function() {
                        addDebugInfo('Image: onerror イベント発生（正常）');
                        resolve('sent');
                    };
                    
                    setTimeout(() => {
                        addDebugInfo('Image: 5秒経過、送信完了と判断');
                        resolve('timeout');
                    }, 5000);
                });
                
                img.src = url;
                addDebugInfo('Image: src設定完了、送信実行');
                lastSendTime = Date.now(); // 送信時刻を記録
                
                const result = await imagePromise;
                addDebugInfo(`Image送信完了: ${result}`);
                updateStatus('✅ 送信完了！スプレッドシートを確認してください', 'success');
                
                // 3秒後にステータスをリセット
                setTimeout(() => {
                    updateStatus('準備完了', 'waiting');
                }, 3000);
                
            } catch (error) {
                addDebugInfo(`Image送信エラー: ${error.message}`);
                updateStatus('❌ 送信エラー', 'error');
            }
        }

        // NFCタグからURL送信（重複防止付き）
        async function sendToNFCUrl(nfcUrl) {
            addDebugInfo('=== NFC URL送信開始 ===');
            addDebugInfo(`NFC URL: ${nfcUrl}`);
            
            // 手動テストで使用したURLと比較
            const correctGasUrl = 'https://script.google.com/macros/s/AKfycbywswLc2pqHUM4Ywc3ZD7JXzDvlgzwgJOzJE-rM3zZSrOeslstFYpW9LTUc91vn0bVy/exec';
            addDebugInfo(`正しいGAS URL: ${correctGasUrl}`);
            addDebugInfo(`URL一致: ${nfcUrl === correctGasUrl ? 'YES' : 'NO'}`);
            
            if (!canSend()) {
                addDebugInfo('重複送信防止のため送信をスキップ');
                return;
            }
            
            const userName = document.getElementById('testUserName').value.trim() || 'Unknown';
            const timestamp = new Date().toLocaleString('ja-JP');
            
            const params = new URLSearchParams({
                timestamp: timestamp,
                action: 'checkin',
                userName: userName,
                inputMethod: 'nfc',
                device: 'Android NFC'
            });
            
            const fullUrl = `${nfcUrl}?${params.toString()}`;
            addDebugInfo(`送信URL: ${fullUrl}`);
            addDebugInfo(`ユーザー名: ${userName}`);
            
            // 警告表示：URLが異なる場合
            if (nfcUrl !== correctGasUrl) {
                updateStatus('⚠️ NFCタグのURLが手動テストと異なります', 'error');
                addDebugInfo('⚠️ 警告: NFCタグのGAS URLが手動テストで使用したものと異なります');
                addDebugInfo('NFCタグの書き込み内容を確認してください');
                
                // それでも送信は試行
                setTimeout(() => {
                    updateStatus(`📡 ${userName}さんのチェックイン送信中...（異なるURL）`, 'waiting');
                }, 2000);
            } else {
                updateStatus(`📡 ${userName}さんのチェックイン送信中...`, 'waiting');
            }
            
            try {
                const img = new Image();
                
                const imagePromise = new Promise((resolve) => {
                    img.onload = () => {
                        addDebugInfo('NFC送信: onload');
                        resolve('success');
                    };
                    img.onerror = () => {
                        addDebugInfo('NFC送信: onerror（正常）');
                        resolve('sent');
                    };
                    setTimeout(() => {
                        addDebugInfo('NFC送信: タイムアウト完了');
                        resolve('timeout');
                    }, 5000);
                });
                
                img.src = fullUrl;
                lastSendTime = Date.now(); // 送信時刻を記録
                
                const result = await imagePromise;
                addDebugInfo(`NFC送信完了: ${result}`);
                
                if (nfcUrl !== correctGasUrl) {
                    updateStatus(`⚠️ 送信完了（異なるGAS URL使用）`, 'error');
                    addDebugInfo('NFCタグに正しいGAS URLを書き込み直すことをお勧めします');
                } else {
                    updateStatus(`😊 ${userName}さん、チェックイン完了！`, 'success');
                }
                
                // 5秒後にステータスをリセット
                setTimeout(() => {
                    updateStatus('📱 次のチェックインをお待ちしています', 'waiting');
                }, 5000);
                
            } catch (error) {
                addDebugInfo(`NFC送信エラー: ${error.message}`);
                updateStatus('❌ NFC送信エラー', 'error');
            }
        }

        // NFC読み込み開始
        async function startNFC() {
            if (!('NDEFReader' in window)) {
                updateStatus('❌ このブラウザはNFCに対応していません', 'error');
                addDebugInfo('NFC非対応ブラウザ');
                return;
            }

            if (isNFCActive) {
                updateStatus('NFC読み込みは既に開始されています', 'waiting');
                return;
            }

            try {
                const ndef = new NDEFReader();
                await ndef.scan();
                
                isNFCActive = true;
                updateStatus('🔍 NFCタグを探しています...', 'waiting');
                document.getElementById('nfcButton').disabled = true;
                addDebugInfo('NFC読み込み開始');

                ndef.addEventListener('reading', async ({ message, serialNumber }) => {
                    addDebugInfo(`NFCタグ検出: ${serialNumber}`);
                    
                    let url = null;
                    let rawUrlData = null; // 生データを保存

                    // NFCデータを解析
                    for (const record of message.records) {
                        addDebugInfo(`レコードタイプ: ${record.recordType}`);

                        if (record.recordType === 'url') {
                            const decoder = new TextDecoder();
                            url = decoder.decode(record.data);
                            rawUrlData = new Uint8Array(record.data);
                            addDebugInfo(`URL取得: ${url}`);
                        } else if (record.recordType === 'text') {
                            const decoder = new TextDecoder();
                            const text = decoder.decode(record.data);
                            rawUrlData = new Uint8Array(record.data);
                            addDebugInfo(`テキスト取得: ${text}`);
                            if (text.startsWith('http')) {
                                url = text;
                            }
                        } else if (record.recordType === 'absolute-url') {
                            const decoder = new TextDecoder();
                            url = decoder.decode(record.data);
                            rawUrlData = new Uint8Array(record.data);
                            addDebugInfo(`絶対URL取得: ${url}`);
                        } else {
                            try {
                                const decoder = new TextDecoder();
                                const decodedText = decoder.decode(record.data);
                                rawUrlData = new Uint8Array(record.data);
                                addDebugInfo(`その他データ: ${decodedText}`);
                                if (decodedText.startsWith('http')) {
                                    url = decodedText;
                                }
                            } catch (e) {
                                addDebugInfo(`デコード失敗: ${e.message}`);
                            }
                        }
                    }

                    if (url) {
                        addDebugInfo(`✅ URL検出成功: ${url}`);
                        
                        // 詳細なURL分析
                        const correctGasUrl = 'https://script.google.com/macros/s/AKfycbywswLc2pqHUM4Ywc3ZD7JXzDvlgzwgJOzJE-rM3zZSrOeslstFYpW9LTUc91vn0bVy/exec';
                        
                        addDebugInfo('=== URL詳細分析 ===');
                        addDebugInfo(`NFC URL: "${url}"`);
                        addDebugInfo(`正解 URL: "${correctGasUrl}"`);
                        addDebugInfo(`長さ比較: NFC=${url.length}, 正解=${correctGasUrl.length}`);
                        addDebugInfo(`完全一致: ${url === correctGasUrl ? 'YES' : 'NO'}`);
                        
                        // 文字コード比較
                        if (rawUrlData) {
                            const hexData = Array.from(rawUrlData).map(b => b.toString(16).padStart(2, '0')).join(' ');
                            addDebugInfo(`生データ(16進): ${hexData.substring(0, 100)}...`);
                        }
                        
                        // URLに既にパラメータが含まれているかチェック
                        if (url.includes('?')) {
                            addDebugInfo(`⚠️ URLに既にパラメータ含有: ${url.split('?')[1]}`);
                        }
                        
                        // URLの末尾文字チェック
                        const lastChar = url.charCodeAt(url.length - 1);
                        addDebugInfo(`末尾文字コード: ${lastChar} (${String.fromCharCode(lastChar)})`);
                        
                        // URLをクリーンアップ
                        const cleanUrl = url.trim();
                        if (cleanUrl !== url) {
                            addDebugInfo(`⚠️ URL前後に空白を検出、クリーンアップ: "${cleanUrl}"`);
                            url = cleanUrl;
                        }
                        
                        await sendToNFCUrl(url);
                    } else {
                        addDebugInfo('❌ URLが見つかりません');
                        updateStatus('❌ NFCタグにURLが見つかりません', 'error');
                    }

                    // 10秒後にNFC読み込みをリセット
                    setTimeout(() => {
                        isNFCActive = false;
                        document.getElementById('nfcButton').disabled = false;
                        addDebugInfo('NFC読み込みリセット');
                    }, 10000);
                });

                ndef.addEventListener('readingerror', (error) => {
                    addDebugInfo(`NFC読み込みエラー: ${error}`);
                    updateStatus('❌ NFC読み込みエラーが発生しました', 'error');
                    isNFCActive = false;
                    document.getElementById('nfcButton').disabled = false;
                });

            } catch (error) {
                addDebugInfo(`NFC開始エラー: ${error.message}`);
                updateStatus(`❌ NFCの開始に失敗: ${error.message}`, 'error');
                isNFCActive = false;
                document.getElementById('nfcButton').disabled = false;
            }
        }

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            addDebugInfo('スマコネアプリ初期化完了（デバッグ版ベース）');
            
            if (!('NDEFReader' in window)) {
                document.getElementById('nfcButton').disabled = true;
                addDebugInfo('NFC機能は利用できません');
            }
            
            updateStatus('準備完了', 'waiting');
        });
    </script>
</body>
</html>
