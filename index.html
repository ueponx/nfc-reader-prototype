<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¹ãƒã‚³ãƒ</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status.waiting {
            background-color: #e3f2fd;
            color: #1976d2;
            border: 2px solid #bbdefb;
        }
        .status.success {
            background-color: #e8f5e8;
            color: #2e7d32;
            border: 2px solid #a5d6a7;
        }
        .status.error {
            background-color: #ffebee;
            color: #c62828;
            border: 2px solid #ef9a9a;
        }
        button {
            width: 100%;
            padding: 15px;
            background-color: #1976d2;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px 0;
        }
        button:hover {
            background-color: #1565c0;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            margin: 10px 0;
            box-sizing: border-box;
        }
        input:focus {
            outline: none;
            border-color: #4a90e2;
        }
        .section {
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
            margin-bottom: 15px;
        }
        .section:last-child {
            border-bottom: none;
        }
        h3 {
            color: #333;
            margin-bottom: 10px;
        }
        .debug-info {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 12px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .test-button {
            background-color: #ff5722;
        }
        .test-button:hover {
            background-color: #e64a19;
        }
        .nfc-button {
            background-color: #4CAF50;
        }
        .nfc-button:hover {
            background-color: #45a049;
        }
        .timestamp {
            text-align: center;
            color: #666;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ˜Š ã‚¹ãƒã‚³ãƒ</h1>
        <div style="text-align: center; color: #666; margin-bottom: 20px;">
            ã‚¹ãƒã‚¤ãƒ«ã‚³ãƒã‚¯ãƒˆï¼ˆãƒ‡ãƒãƒƒã‚°ç‰ˆãƒ™ãƒ¼ã‚¹ï¼‰
        </div>
        
        <div class="section">
            <h3>ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š</h3>
            <input type="text" id="testUserName" value="ç”°ä¸­å¤ªéƒ" placeholder="ãƒ†ã‚¹ãƒˆç”¨ãƒ¦ãƒ¼ã‚¶ãƒ¼å" />
        </div>
        
        <div class="section">
            <h3>ğŸ“± ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³</h3>
            <div id="status" class="status waiting">æº–å‚™å®Œäº†</div>
            <div class="timestamp" id="currentTime"></div>
            
            <button class="test-button" onclick="testImageMethod()">ğŸ§ª æ‰‹å‹•ãƒ†ã‚¹ãƒˆé€ä¿¡ï¼ˆImageæ–¹å¼ï¼‰</button>
            <button class="nfc-button" id="nfcButton" onclick="startNFC()">ğŸ“± NFCèª­ã¿è¾¼ã¿é–‹å§‹</button>
        </div>
        
        <div class="section">
            <h3>ğŸ” ãƒ‡ãƒãƒƒã‚°æƒ…å ±</h3>
            <div class="debug-info" id="debugInfo">ã“ã“ã«ãƒ‡ãƒãƒƒã‚°æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
        </div>
    </div>

    <script>
        let isNFCActive = false;
        let lastSendTime = 0;
        const SEND_INTERVAL = 5000; // 5ç§’é–“ã¯é‡è¤‡é€ä¿¡ã‚’é˜²ã

        // ç¾åœ¨æ™‚åˆ»ã®è¡¨ç¤ºã‚’æ›´æ–°
        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleString('ja-JP', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('currentTime').textContent = `ç¾åœ¨æ™‚åˆ»: ${timeString}`;
        }

        // 1ç§’ã”ã¨ã«æ™‚åˆ»ã‚’æ›´æ–°
        setInterval(updateCurrentTime, 1000);
        updateCurrentTime();

        function updateStatus(message, type = 'waiting') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }

        function addDebugInfo(info) {
            const debugElement = document.getElementById('debugInfo');
            const timestamp = new Date().toLocaleString('ja-JP');
            debugElement.textContent += `[${timestamp}] ${info}\n`;
            console.log(`[${timestamp}] ${info}`);
        }

        // ãƒ‡ãƒãƒƒã‚°ç‰ˆã¨åŒã˜URLæ§‹ç¯‰æ–¹æ³•
        function buildTestURL() {
            const gasUrl = 'https://script.google.com/macros/s/AKfycbywswLc2pqHUM4Ywc3ZD7JXzDvlgzwgJOzJE-rM3zZSrOeslstFYpW9LTUc91vn0bVy/exec';
            const userName = document.getElementById('testUserName').value.trim() || 'Unknown';
            
            const timestamp = new Date().toLocaleString('ja-JP');
            const params = new URLSearchParams({
                timestamp: timestamp,
                action: 'checkin',
                userName: userName,
                inputMethod: 'manual',
                device: 'Android NFC'
            });
            
            const fullUrl = `${gasUrl}?${params.toString()}`;
            addDebugInfo(`URLæ§‹ç¯‰: ${fullUrl}`);
            addDebugInfo(`ãƒ¦ãƒ¼ã‚¶ãƒ¼å: ${userName}`);
            return fullUrl;
        }

        // é‡è¤‡é€ä¿¡é˜²æ­¢ãƒã‚§ãƒƒã‚¯
        function canSend() {
            const now = Date.now();
            if (now - lastSendTime < SEND_INTERVAL) {
                addDebugInfo(`é‡è¤‡é€ä¿¡é˜²æ­¢: ${Math.round((SEND_INTERVAL - (now - lastSendTime)) / 1000)}ç§’å¾…æ©ŸãŒå¿…è¦`);
                return false;
            }
            return true;
        }

        // ãƒ‡ãƒãƒƒã‚°ç‰ˆã¨åŒã˜Imageæ–¹å¼é€ä¿¡
        async function testImageMethod() {
            addDebugInfo('=== Imageæ–¹å¼ãƒ†ã‚¹ãƒˆé–‹å§‹ ===');
            
            if (!canSend()) {
                updateStatus('âŒ é€ä¿¡é–“éš”ãŒçŸ­ã™ãã¾ã™ã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ãã ã•ã„ã€‚', 'error');
                return;
            }
            
            const url = buildTestURL();
            updateStatus('ğŸ–¼ï¸ Imageæ–¹å¼ã§é€ä¿¡ä¸­...', 'waiting');
            
            try {
                const img = new Image();
                
                const imagePromise = new Promise((resolve) => {
                    img.onload = function() {
                        addDebugInfo('Image: onload ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿï¼ˆçã—ã„ï¼‰');
                        resolve('success');
                    };
                    
                    img.onerror = function() {
                        addDebugInfo('Image: onerror ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿï¼ˆæ­£å¸¸ï¼‰');
                        resolve('sent');
                    };
                    
                    setTimeout(() => {
                        addDebugInfo('Image: 5ç§’çµŒéã€é€ä¿¡å®Œäº†ã¨åˆ¤æ–­');
                        resolve('timeout');
                    }, 5000);
                });
                
                img.src = url;
                addDebugInfo('Image: srcè¨­å®šå®Œäº†ã€é€ä¿¡å®Ÿè¡Œ');
                lastSendTime = Date.now(); // é€ä¿¡æ™‚åˆ»ã‚’è¨˜éŒ²
                
                const result = await imagePromise;
                addDebugInfo(`Imageé€ä¿¡å®Œäº†: ${result}`);
                updateStatus('âœ… é€ä¿¡å®Œäº†ï¼ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„', 'success');
                
                // 3ç§’å¾Œã«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
                setTimeout(() => {
                    updateStatus('æº–å‚™å®Œäº†', 'waiting');
                }, 3000);
                
            } catch (error) {
                addDebugInfo(`Imageé€ä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                updateStatus('âŒ é€ä¿¡ã‚¨ãƒ©ãƒ¼', 'error');
            }
        }

        // NFCã‚¿ã‚°ã‹ã‚‰URLé€ä¿¡ï¼ˆé‡è¤‡é˜²æ­¢ä»˜ãï¼‰
        async function sendToNFCUrl(nfcUrl) {
            addDebugInfo('=== NFC URLé€ä¿¡é–‹å§‹ ===');
            addDebugInfo(`NFC URL: ${nfcUrl}`);
            
            // æ‰‹å‹•ãƒ†ã‚¹ãƒˆã§ä½¿ç”¨ã—ãŸURLã¨æ¯”è¼ƒ
            const correctGasUrl = 'https://script.google.com/macros/s/AKfycbywswLc2pqHUM4Ywc3ZD7JXzDvlgzwgJOzJE-rM3zZSrOeslstFYpW9LTUc91vn0bVy/exec';
            addDebugInfo(`æ­£ã—ã„GAS URL: ${correctGasUrl}`);
            addDebugInfo(`URLä¸€è‡´: ${nfcUrl === correctGasUrl ? 'YES' : 'NO'}`);
            
            if (!canSend()) {
                addDebugInfo('é‡è¤‡é€ä¿¡é˜²æ­¢ã®ãŸã‚é€ä¿¡ã‚’ã‚¹ã‚­ãƒƒãƒ—');
                return;
            }
            
            const userName = document.getElementById('testUserName').value.trim() || 'Unknown';
            const timestamp = new Date().toLocaleString('ja-JP');
            
            const params = new URLSearchParams({
                timestamp: timestamp,
                action: 'checkin',
                userName: userName,
                inputMethod: 'nfc',
                device: 'Android NFC'
            });
            
            const fullUrl = `${nfcUrl}?${params.toString()}`;
            addDebugInfo(`é€ä¿¡URL: ${fullUrl}`);
            addDebugInfo(`ãƒ¦ãƒ¼ã‚¶ãƒ¼å: ${userName}`);
            
            // è­¦å‘Šè¡¨ç¤ºï¼šURLãŒç•°ãªã‚‹å ´åˆ
            if (nfcUrl !== correctGasUrl) {
                updateStatus('âš ï¸ NFCã‚¿ã‚°ã®URLãŒæ‰‹å‹•ãƒ†ã‚¹ãƒˆã¨ç•°ãªã‚Šã¾ã™', 'error');
                addDebugInfo('âš ï¸ è­¦å‘Š: NFCã‚¿ã‚°ã®GAS URLãŒæ‰‹å‹•ãƒ†ã‚¹ãƒˆã§ä½¿ç”¨ã—ãŸã‚‚ã®ã¨ç•°ãªã‚Šã¾ã™');
                addDebugInfo('NFCã‚¿ã‚°ã®æ›¸ãè¾¼ã¿å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„');
                
                // ãã‚Œã§ã‚‚é€ä¿¡ã¯è©¦è¡Œ
                setTimeout(() => {
                    updateStatus(`ğŸ“¡ ${userName}ã•ã‚“ã®ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³é€ä¿¡ä¸­...ï¼ˆç•°ãªã‚‹URLï¼‰`, 'waiting');
                }, 2000);
            } else {
                updateStatus(`ğŸ“¡ ${userName}ã•ã‚“ã®ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³é€ä¿¡ä¸­...`, 'waiting');
            }
            
            try {
                const img = new Image();
                
                const imagePromise = new Promise((resolve) => {
                    img.onload = () => {
                        addDebugInfo('NFCé€ä¿¡: onload');
                        resolve('success');
                    };
                    img.onerror = () => {
                        addDebugInfo('NFCé€ä¿¡: onerrorï¼ˆæ­£å¸¸ï¼‰');
                        resolve('sent');
                    };
                    setTimeout(() => {
                        addDebugInfo('NFCé€ä¿¡: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå®Œäº†');
                        resolve('timeout');
                    }, 5000);
                });
                
                img.src = fullUrl;
                lastSendTime = Date.now(); // é€ä¿¡æ™‚åˆ»ã‚’è¨˜éŒ²
                
                const result = await imagePromise;
                addDebugInfo(`NFCé€ä¿¡å®Œäº†: ${result}`);
                
                if (nfcUrl !== correctGasUrl) {
                    updateStatus(`âš ï¸ é€ä¿¡å®Œäº†ï¼ˆç•°ãªã‚‹GAS URLä½¿ç”¨ï¼‰`, 'error');
                    addDebugInfo('NFCã‚¿ã‚°ã«æ­£ã—ã„GAS URLã‚’æ›¸ãè¾¼ã¿ç›´ã™ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™');
                } else {
                    updateStatus(`ğŸ˜Š ${userName}ã•ã‚“ã€ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³å®Œäº†ï¼`, 'success');
                }
                
                // 5ç§’å¾Œã«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
                setTimeout(() => {
                    updateStatus('ğŸ“± æ¬¡ã®ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã‚’ãŠå¾…ã¡ã—ã¦ã„ã¾ã™', 'waiting');
                }, 5000);
                
            } catch (error) {
                addDebugInfo(`NFCé€ä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                updateStatus('âŒ NFCé€ä¿¡ã‚¨ãƒ©ãƒ¼', 'error');
            }
        }

        // NFCèª­ã¿è¾¼ã¿é–‹å§‹
        async function startNFC() {
            if (!('NDEFReader' in window)) {
                updateStatus('âŒ ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯NFCã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“', 'error');
                addDebugInfo('NFCéå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶');
                return;
            }

            if (isNFCActive) {
                updateStatus('NFCèª­ã¿è¾¼ã¿ã¯æ—¢ã«é–‹å§‹ã•ã‚Œã¦ã„ã¾ã™', 'waiting');
                return;
            }

            try {
                const ndef = new NDEFReader();
                await ndef.scan();
                
                isNFCActive = true;
                updateStatus('ğŸ” NFCã‚¿ã‚°ã‚’æ¢ã—ã¦ã„ã¾ã™...', 'waiting');
                document.getElementById('nfcButton').disabled = true;
                addDebugInfo('NFCèª­ã¿è¾¼ã¿é–‹å§‹');

                ndef.addEventListener('reading', async ({ message, serialNumber }) => {
                    addDebugInfo(`NFCã‚¿ã‚°æ¤œå‡º: ${serialNumber}`);
                    
                    let url = null;
                    let rawUrlData = null; // ç”Ÿãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜

                    // NFCãƒ‡ãƒ¼ã‚¿ã‚’è§£æ
                    for (const record of message.records) {
                        addDebugInfo(`ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ—: ${record.recordType}`);

                        if (record.recordType === 'url') {
                            const decoder = new TextDecoder();
                            url = decoder.decode(record.data);
                            rawUrlData = new Uint8Array(record.data);
                            addDebugInfo(`URLå–å¾—: ${url}`);
                        } else if (record.recordType === 'text') {
                            const decoder = new TextDecoder();
                            const text = decoder.decode(record.data);
                            rawUrlData = new Uint8Array(record.data);
                            addDebugInfo(`ãƒ†ã‚­ã‚¹ãƒˆå–å¾—: ${text}`);
                            if (text.startsWith('http')) {
                                url = text;
                            }
                        } else if (record.recordType === 'absolute-url') {
                            const decoder = new TextDecoder();
                            url = decoder.decode(record.data);
                            rawUrlData = new Uint8Array(record.data);
                            addDebugInfo(`çµ¶å¯¾URLå–å¾—: ${url}`);
                        } else {
                            try {
                                const decoder = new TextDecoder();
                                const decodedText = decoder.decode(record.data);
                                rawUrlData = new Uint8Array(record.data);
                                addDebugInfo(`ãã®ä»–ãƒ‡ãƒ¼ã‚¿: ${decodedText}`);
                                if (decodedText.startsWith('http')) {
                                    url = decodedText;
                                }
                            } catch (e) {
                                addDebugInfo(`ãƒ‡ã‚³ãƒ¼ãƒ‰å¤±æ•—: ${e.message}`);
                            }
                        }
                    }

                    if (url) {
                        addDebugInfo(`âœ… URLæ¤œå‡ºæˆåŠŸ: ${url}`);
                        
                        // è©³ç´°ãªURLåˆ†æ
                        const correctGasUrl = 'https://script.google.com/macros/s/AKfycbywswLc2pqHUM4Ywc3ZD7JXzDvlgzwgJOzJE-rM3zZSrOeslstFYpW9LTUc91vn0bVy/exec';
                        
                        addDebugInfo('=== URLè©³ç´°åˆ†æ ===');
                        addDebugInfo(`NFC URL: "${url}"`);
                        addDebugInfo(`æ­£è§£ URL: "${correctGasUrl}"`);
                        addDebugInfo(`é•·ã•æ¯”è¼ƒ: NFC=${url.length}, æ­£è§£=${correctGasUrl.length}`);
                        addDebugInfo(`å®Œå…¨ä¸€è‡´: ${url === correctGasUrl ? 'YES' : 'NO'}`);
                        
                        // æ–‡å­—ã‚³ãƒ¼ãƒ‰æ¯”è¼ƒ
                        if (rawUrlData) {
                            const hexData = Array.from(rawUrlData).map(b => b.toString(16).padStart(2, '0')).join(' ');
                            addDebugInfo(`ç”Ÿãƒ‡ãƒ¼ã‚¿(16é€²): ${hexData.substring(0, 100)}...`);
                        }
                        
                        // URLã«æ—¢ã«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                        if (url.includes('?')) {
                            addDebugInfo(`âš ï¸ URLã«æ—¢ã«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å«æœ‰: ${url.split('?')[1]}`);
                        }
                        
                        // URLã®æœ«å°¾æ–‡å­—ãƒã‚§ãƒƒã‚¯
                        const lastChar = url.charCodeAt(url.length - 1);
                        addDebugInfo(`æœ«å°¾æ–‡å­—ã‚³ãƒ¼ãƒ‰: ${lastChar} (${String.fromCharCode(lastChar)})`);
                        
                        // URLã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                        const cleanUrl = url.trim();
                        if (cleanUrl !== url) {
                            addDebugInfo(`âš ï¸ URLå‰å¾Œã«ç©ºç™½ã‚’æ¤œå‡ºã€ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—: "${cleanUrl}"`);
                            url = cleanUrl;
                        }
                        
                        await sendToNFCUrl(url);
                    } else {
                        addDebugInfo('âŒ URLãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                        updateStatus('âŒ NFCã‚¿ã‚°ã«URLãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                    }

                    // 10ç§’å¾Œã«NFCèª­ã¿è¾¼ã¿ã‚’ãƒªã‚»ãƒƒãƒˆ
                    setTimeout(() => {
                        isNFCActive = false;
                        document.getElementById('nfcButton').disabled = false;
                        addDebugInfo('NFCèª­ã¿è¾¼ã¿ãƒªã‚»ãƒƒãƒˆ');
                    }, 10000);
                });

                ndef.addEventListener('readingerror', (error) => {
                    addDebugInfo(`NFCèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error}`);
                    updateStatus('âŒ NFCèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
                    isNFCActive = false;
                    document.getElementById('nfcButton').disabled = false;
                });

            } catch (error) {
                addDebugInfo(`NFCé–‹å§‹ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                updateStatus(`âŒ NFCã®é–‹å§‹ã«å¤±æ•—: ${error.message}`, 'error');
                isNFCActive = false;
                document.getElementById('nfcButton').disabled = false;
            }
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            addDebugInfo('ã‚¹ãƒã‚³ãƒã‚¢ãƒ—ãƒªåˆæœŸåŒ–å®Œäº†ï¼ˆãƒ‡ãƒãƒƒã‚°ç‰ˆãƒ™ãƒ¼ã‚¹ï¼‰');
            
            if (!('NDEFReader' in window)) {
                document.getElementById('nfcButton').disabled = true;
                addDebugInfo('NFCæ©Ÿèƒ½ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“');
            }
            
            updateStatus('æº–å‚™å®Œäº†', 'waiting');
        });
    </script>
</body>
</html>
